# Nginx configuration for Ghost CMS
# Place this in your server block or include it in your main nginx config

# Increase client body size for file uploads
client_max_body_size 50M;
client_body_buffer_size 128k;

# Increase timeouts for large file uploads
client_body_timeout 300s;
client_header_timeout 300s;
keepalive_timeout 300s;
send_timeout 300s;

# Proxy timeouts if using proxy_pass
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;

# FastCGI timeouts if using PHP-FPM
fastcgi_send_timeout 300s;
fastcgi_read_timeout 300s;

# Buffer sizes for large uploads
client_body_temp_path /var/tmp;
client_body_in_file_only off;

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss application/xhtml+xml image/svg+xml;

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;

# Cache static assets
location ~* \.(jpg|jpeg|png|gif|webp|ico|css|js|woff|woff2|ttf)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Cache video files with shorter expiry
location ~* \.(mp4|webm|ogg|mov)$ {
    expires 30d;
    add_header Cache-Control "public";
    # Allow larger responses for video streaming
    proxy_max_temp_file_size 1024m;
}

# Handle Ghost admin area
location /ghost/admin {
    # Ensure body size limit applies here
    client_max_body_size 50M;
    
    # If using proxy_pass to an app server
    # proxy_pass http://localhost:8080;
    # proxy_set_header Host $host;
    # proxy_set_header X-Real-IP $remote_addr;
    # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # proxy_set_header X-Forwarded-Proto $scheme;
}

# Handle AJAX upload endpoints specifically
location ~ ^/ghost/admin/ajax/(upload-image|upload-video)\.cfm$ {
    # Even larger limit for upload endpoints
    client_max_body_size 100M;
    client_body_buffer_size 256k;
    
    # Disable request buffering for uploads
    proxy_request_buffering off;
    
    # If using FastCGI for ColdFusion
    # fastcgi_pass unix:/var/run/cfusion.sock;
    # fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    # include fastcgi_params;
    # fastcgi_buffer_size 128k;
    # fastcgi_buffers 4 256k;
    # fastcgi_busy_buffers_size 256k;
}

# Specific handling for video uploads
location = /ghost/admin/ajax/upload-video.cfm {
    client_max_body_size 100M;
    client_body_timeout 600s;
    
    # Progress tracking (requires nginx upload progress module)
    # track_uploads proxied 30s;
}

# Handle Ghost content directory
location /ghost/content {
    # Direct file serving
    try_files $uri =404;
    
    # CORS headers for content if needed
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
}

# WebSocket support if needed for real-time features
location /ghost/websocket {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

# Rate limiting for security
limit_req_zone $binary_remote_addr zone=ghost_upload:10m rate=10r/s;
location ~ ^/ghost/admin/ajax/upload {
    limit_req zone=ghost_upload burst=20 nodelay;
}